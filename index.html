<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0E1013" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
  <style>
    :root{
      /* === –ü–∞–ª–∏—Ç—Ä–∞ / –ú–∞–∫–µ—Ç –∫–∞–∫ –Ω–∞ –º–∞–∫–µ—Ç–µ === */
      --bg:#0E1013;              /* –æ–±—â–∏–π —Ñ–æ–Ω */
      --surface:#12151A;         /* –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å/–Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
      --card:#161A21;            /* –∫–∞—Ä—Ç–æ—á–∫–∏ */
      --card-2:#0f1217;          /* –≥–ª—É–±–æ–∫–∞—è —Ç–µ–Ω—å –∫–∞—Ä—Ç–æ—á–∫–∏ */
      --hair:#262b33;            /* —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ */
      --text:#ECEFF4;            /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted:#9AA3AD;           /* –ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–π */
      --accent:#3D7CFF;          /* –∞–∫—Ü–µ–Ω—Ç –∫–∞–∫ –∫–Ω–æ–ø–∫–∏/–∏–∫–æ–Ω–∫–∏ */
      --accent-2:#6AA2FF;        /* —Å–≤–µ—Ç–ª—ã–π –∞–∫—Ü–µ–Ω—Ç */
      --danger:#ff5151;
      --ok:#00c27a;
      --warn:#f0b429;

      --radius:16px;             /* —Ä–∞–¥–∏—É—Å –∫–∞—Ä—Ç–æ—á–µ–∫ (–∫—Ä—É–ø–Ω—ã–π) */
      --radius-sm:12px;          /* —Ä–∞–¥–∏—É—Å –ø–æ–º–µ–Ω—å—à–µ */
      --shadow:0 6px 24px rgba(0,0,0,.45);     /* —Ç–µ–Ω—å –∫–∞—Ä—Ç–æ—á–µ–∫ */
      --shadow-soft:0 10px 40px rgba(0,0,0,.35);

      /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
      --fz:16px;                 /* –±–∞–∑–∞ 16px —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∞–≤—Ç–æ-–∑—É–º–∞ */
      --fz-sm:13px;
      --fz-lg:18px;
      --fw-bold:650;

      /* –ü–æ–≤–µ–¥–µ–Ω–∏–µ */
      --safe-btm: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --viewport-height: 100dvh;
      --keyboard-offset: 0px;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font: 400 var(--fz)/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans';
    }
    img,video{max-width:100%;display:block}

    .hidden{display:none !important}

    /* ====== Desktop blocker ====== */
    .desktop-blocker{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg,#0c0f13,#0b0e12);
      z-index:9999;padding:24px;text-align:center;
    }
    .desktop-blocker__card{
      background:linear-gradient(180deg,var(--card),var(--card-2));
      border:1px solid var(--hair); border-radius:var(--radius); padding:24px; max-width:520px; box-shadow:var(--shadow);
    }
    .desktop-blocker h1{margin:0 0 8px;font-weight:var(--fw-bold)}
    .muted{color:var(--muted)}

    /* ====== –ö–∞—Ä–∫–∞—Å ====== */
    .app{
      display:flex;
      flex-direction:column;
      min-height:var(--viewport-height);
      height:var(--viewport-height);
    }
    .topbar{
      position:sticky;top:0;padding:12px 16px;padding-top:calc(12px + var(--safe-top));
      background:var(--surface);border-bottom:1px solid var(--hair);
      display:flex;align-items:center;justify-content:space-between;gap:8px;z-index:10;
    }
    .topbar__title{display:flex;align-items:center;gap:10px;font-weight:var(--fw-bold)}
    .badge{background:#1d2330;border:1px solid #283147;color:#b7cdfd;border-radius:999px;padding:2px 10px;font-size:12px}
    .icon-btn{background:#121721;border:1px solid var(--hair);border-radius:12px;color:#c7d2fe;padding:8px 10px}

    .swipe{flex:1;display:flex;transition:transform .25s ease;will-change:transform;overflow:hidden;touch-action:pan-y}
    .screen{min-width:100%;padding-bottom:96px}

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–∫ –Ω–∞ –º–∞–∫–µ—Ç–µ ====== */
    .card{
      background:linear-gradient(180deg,var(--card),var(--card-2));
      border:1px solid var(--hair); border-radius:var(--radius); box-shadow:var(--shadow);
    }

    /* ====== –ß–∞—Ç ====== */
    .chat-wrap{padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{display:flex;gap:8px}
    .msg--me{justify-content:flex-end}
    .bubble{
      max-width:80%;
      background:linear-gradient(180deg,#1a2030,#141924);
      border:1px solid #243149;
      border-radius:14px; padding:10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      word-wrap:break-word;
    }
    .bubble--me{background:linear-gradient(180deg,#1e2a45,#172235);border-color:#2c3b5e}
    .bubble__meta{margin-top:4px;font-size:12px;color:var(--muted)}

    .composer{
      position:fixed;left:0;right:0;bottom:calc(56px + var(--safe-btm) + var(--keyboard-offset));
      display:flex;gap:8px;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#0f1216,#0c0f13);border-top:1px solid var(--hair)
    }
    .composer input[type="text"]{
      flex:1;background:#121722;border:1px solid var(--hair);border-radius:14px;padding:12px 14px;color:var(--text);font-size:16px
    }
    .composer .file-btn{display:flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:14px;background:#121722;border:1px dashed var(--hair)}
    .composer .file-btn input{display:none}
    .composer .send{height:48px;padding:0 16px;border-radius:14px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;font-weight:600}

    /* ====== –°–¥–µ–ª–∫–∏ ====== */
    .deals-wrap{padding:12px;display:flex;flex-direction:column;gap:12px}
    .deal{overflow:hidden}
    .deal__top{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
    .deal__title{font-weight:var(--fw-bold)}
    .deal__body{border-top:1px solid var(--hair);padding:12px 14px;display:none}
    .deal--open .deal__body{display:block}
    .deal__section{margin-bottom:12px}
    .deal__grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .deal__grid img,.deal__grid video{border-radius:12px;max-height:160px;object-fit:cover;width:100%}
    .deal__add{display:block;text-align:center;padding:10px;border-radius:12px;border:1px dashed #2a3a5c;background:#121722}
    .deal__form label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
    .deal__form input,.deal__form textarea{width:100%;background:#10141b;border:1px solid var(--hair);border-radius:12px;color:#fff;padding:10px;font-size:16px}
    .deal__form textarea{min-height:90px}

    .btn{border:0;border-radius:12px;padding:12px 14px}
    .btn--primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff}
    .btn--danger{background:linear-gradient(180deg,#ff5a5a,#ff3d3d);color:#fff}
    .btn--ghost{background:#121722;border:1px solid var(--hair);color:#d6defa}
    .btn--fab{position:fixed;right:14px;bottom:calc(62px + var(--safe-btm));border-radius:999px;padding:12px 16px}

    /* ====== –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–Ω–∏–∂–Ω–∏–π —à–∏—Ç) ====== */
    .sheet{position:fixed;left:0;right:0;bottom:0;max-height:72%;background:var(--surface);border-top:1px solid var(--hair);border-radius:16px 16px 0 0;box-shadow:var(--shadow-soft);display:flex;flex-direction:column}
    .sheet__head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--hair)}
    .sheet__body{padding:12px 14px;overflow:auto}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--hair);border-radius:12px;padding:10px}

    /* ====== –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ====== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal__card{width:92%;max-width:420px;background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--hair);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:8px;margin-bottom:8px}
    .tab{flex:1;background:#10151e;border:1px solid var(--hair);border-radius:12px;color:#c7d2fe;padding:10px}
    .tab--active{background:#172035;border-color:#2a3f68}
    .fld label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
    .fld input{width:100%;background:#0f141b;border:1px solid var(--hair);border-radius:12px;color:#fff;padding:12px;font-size:16px}
    .info{background:#0f141b;border:1px solid var(--hair);color:#cfe0ff;padding:12px;border-radius:12px;margin-top:10px}

    /* ====== –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å ====== */
    .bottombar{
      position:fixed;left:0;right:0;bottom:0;height:56px;padding:8px 10px;padding-bottom:calc(8px + var(--safe-btm));
      background:var(--surface);border-top:1px solid var(--hair);display:flex;align-items:center;gap:8px
    }
    .tabbtn{background:#10141b;border:1px solid var(--hair);border-radius:12px;padding:10px 12px;color:#c7d2fe}
    .tabbtn--active{background:#172035;border-color:#2a3f68}
    .grow{flex:1}
  </style>
</head>
<body>
  <!-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ü–ö -->
  <div id="desktop-blocker" class="desktop-blocker hidden">
    <div class="desktop-blocker__card">
      <h1>–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h1>
      <p class="muted">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞–∫ PWA.</p>
    </div>
  </div>

  <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
  <div id="app" class="app hidden">
    <header class="topbar">
      <div class="topbar__title">
        <span id="role-badge" class="badge">‚Äî</span>
        <span id="title">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <select id="client-switcher" class="icon-btn hidden" title="–í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞"></select>
        <button id="admin-btn" class="icon-btn hidden" title="–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">‚öôÔ∏è</button>
      </div>
    </header>

    <div id="swipe" class="swipe">
      <!-- –≠–∫—Ä–∞–Ω: –ß–ê–¢ -->
      <section class="screen">
        <div id="chat-list" class="chat-wrap"></div>
        <form id="composer" class="composer">
          <input id="msg-text" type="text" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
          <label class="file-btn">üìé
            <input id="msg-file" type="file" accept="image/*,video/*" capture="environment" />
          </label>
          <button class="send" type="submit">–û—Ç–ø—Ä.</button>
        </form>
      </section>

      <!-- –≠–∫—Ä–∞–Ω: –°–î–ï–õ–ö–ò -->
      <section class="screen">
        <div id="deals" class="deals-wrap"></div>
        <button id="add-deal" class="btn btn--primary btn--fab hidden">+ –°–¥–µ–ª–∫–∞</button>
      </section>
    </div>

    <!-- –ê–¥–º–∏–Ω-—à–∏—Ç -->
    <div id="admin-sheet" class="sheet hidden">
      <div class="sheet__head">
        <strong>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</strong>
        <button id="admin-close" class="icon-btn">‚úñ</button>
      </div>
      <div class="sheet__body">
        <section>
          <h3>–û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h3>
          <div id="pending-list" class="list"></div>
        </section>
        <section style="margin-top:12px">
          <h3>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</h3>
          <div id="assign-list" class="list"></div>
        </section>
      </div>
    </div>

    <footer class="bottombar">
      <button id="tab-chat" class="tabbtn tabbtn--active">–ß–∞—Ç</button>
      <button id="tab-deals" class="tabbtn">–°–¥–µ–ª–∫–∏</button>
      <div class="grow"></div>
      <button id="logout" class="btn btn--danger">–í—ã—Ö–æ–¥</button>
    </footer>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="auth-modal" class="modal hidden">
    <div class="modal__card">
      <div class="tabs">
        <button id="tab-login" class="tab tab--active">–í–æ–π—Ç–∏</button>
        <button id="tab-reg" class="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <div id="login-view">
        <div class="fld">
          <label>Email</label>
          <input id="login-email" type="email" inputmode="email" autocomplete="username" required />
        </div>
        <div class="fld">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input id="login-pass" type="password" autocomplete="current-password" required />
        </div>
        <button id="login-btn" class="btn btn--primary" style="width:100%;margin-top:10px">–í–æ–π—Ç–∏</button>

        <div id="login-pending" class="info hidden">
          <strong>–ó–∞—è–≤–∫–∞ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</strong>
          <div>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—è—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ä–µ—Å—É—Ä—Å–∞. –ï—Å–ª–∏ –≤—ã —Å –Ω–∏–º –∑–Ω–∞–∫–æ–º—ã ‚Äî —É–≤–µ–¥–æ–º—å—Ç–µ —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.</div>
        </div>
      </div>

      <div id="reg-view" class="hidden">
        <div class="fld">
          <label>Email</label>
          <input id="reg-email" type="email" inputmode="email" autocomplete="username" required />
        </div>
        <div class="fld">
          <label>–ò–º—è (–≤ —á–∞—Ç–µ)</label>
          <input id="reg-name" type="text" minlength="2" autocomplete="name" required />
        </div>
        <div class="fld">
          <label>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω</label>
          <input id="reg-username" type="text" minlength="3" maxlength="32" pattern="[a-zA-Z0-9_.-]{3,32}" autocomplete="nickname" required />
        </div>
        <div class="fld">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="reg-phone" type="tel" inputmode="tel" autocomplete="tel" />
        </div>
        <div class="fld">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input id="reg-pass" type="password" minlength="6" autocomplete="new-password" required />
        </div>
        <button id="reg-btn" class="btn btn--primary" style="width:100%;margin-top:10px">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

        <div id="reg-ok" class="info hidden">
          <strong>–í–∞—à–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—è—Ç—ã</strong>
          <div>–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ï—Å–ª–∏ –≤—ã –∑–Ω–∞–∫–æ–º—ã ‚Äî —Å–æ–æ–±—â–∏—Ç–µ –µ–º—É –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  /********** –ù–∞—Å—Ç—Ä–æ–µ—á–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã **********/
  const SUPABASE_URL = "https://guoacfwfjunuqpdvjfwp.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1b2FjZndmanVudXFwZHZqZndwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MDEwODYsImV4cCI6MjA3ODE3NzA4Nn0.WuUs9pXqncVnRm33K-Y3DQcpQByk4xVoxVqPPneqRxI";

  /********** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è **********/
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
    realtime: { params: { eventsPerSecond: 5 } }
  });

  /********** DOM **********/
  const app = document.getElementById('app');
  const blocker = document.getElementById('desktop-blocker');

  const roleBadge = document.getElementById('role-badge');
  const titleEl = document.getElementById('title');
  const adminBtn = document.getElementById('admin-btn');
  const adminSheet = document.getElementById('admin-sheet');
  const adminClose = document.getElementById('admin-close');
  const pendingList = document.getElementById('pending-list');
  const assignList = document.getElementById('assign-list');

  const swipe = document.getElementById('swipe');
  const tabChat = document.getElementById('tab-chat');
  const tabDeals = document.getElementById('tab-deals');

  const chatList = document.getElementById('chat-list');
  const composer = document.getElementById('composer');
  const msgText = document.getElementById('msg-text');
  const msgFile = document.getElementById('msg-file');

  const dealsWrap = document.getElementById('deals');
  const addDealBtn = document.getElementById('add-deal');
  const logoutBtn = document.getElementById('logout');

  const authModal = document.getElementById('auth-modal');
  const tabLogin = document.getElementById('tab-login');
  const tabReg = document.getElementById('tab-reg');
  const loginView = document.getElementById('login-view');
  const regView = document.getElementById('reg-view');
  const loginEmail = document.getElementById('login-email');
  const loginPass = document.getElementById('login-pass');
  const loginBtn = document.getElementById('login-btn');
  const loginPending = document.getElementById('login-pending');
  const regEmail = document.getElementById('reg-email');
  const regName = document.getElementById('reg-name');
  const regUser = document.getElementById('reg-username');
  const regPhone = document.getElementById('reg-phone');
  const regPass = document.getElementById('reg-pass');
  const regBtn = document.getElementById('reg-btn');
  const regOk = document.getElementById('reg-ok');

  const clientSwitcher = document.getElementById('client-switcher');

  /********** –°–æ—Å—Ç–æ—è–Ω–∏–µ **********/
  let actor = null;                // { kind:'admin'|'client', role?: 'admin1'|'admin2'|'admin_team', row }
  let currentClientId = null;
  let subMsgs = null, subDeals = null;

  /********** –£—Ç–∏–ª–∏—Ç—ã **********/
  const isMobile = () => {
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    return isTouch && /Android|iPhone|iPad|iPod/i.test(ua);
  };
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');
  const fmt = ts => new Date(ts).toLocaleString();

  function enforceMobileOnly(){
    if(isMobile()){ hide(blocker); show(app); }
    else { show(blocker); hide(app); }
  }

  async function isUsernameFree(username){
    const [{ data: a }, { data: c }] = await Promise.all([
      sb.from('admin_users').select('username').eq('username', username).maybeSingle(),
      sb.from('clients').select('username').eq('username', username).maybeSingle()
    ]);
    return !a && !c;
  }

  /********** –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è **********/
  tabLogin.onclick = () => { tabLogin.classList.add('tab--active'); tabReg.classList.remove('tab--active'); show(loginView); hide(regView); };
  tabReg.onclick   = () => { tabReg.classList.add('tab--active'); tabLogin.classList.remove('tab--active'); show(regView); hide(loginView); };

  loginBtn.onclick = async () => {
    hide(loginPending);

    /* === –õ–û–ì: –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ (–±–µ–∑ –ø–∞—Ä–æ–ª—è) ================================= */
    try {
      await sb.from('audit_log').insert({
        event: 'auth_attempt',
        payload: { email: loginEmail.value.trim().toLowerCase() },
        user_agent: navigator.userAgent
      });
    } catch(e) { /* —Ç–∏—Ö–æ */ }

    const { error } = await sb.auth.signInWithPassword({
      email: loginEmail.value.trim().toLowerCase(),
      password: loginPass.value
    });
    if(error){ alert(error.message); return; }

    /* === –õ–û–ì: —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ ============================================== */
    try {
      const { data: { user } } = await sb.auth.getUser();
      await sb.from('audit_log').insert({
        event: 'auth_success',
        actor_id: user?.id || null,
        payload: { email: loginEmail.value.trim().toLowerCase() },
        user_agent: navigator.userAgent
      });
    } catch(e) { /* —Ç–∏—Ö–æ */ }

    await postAuth();
  };

  regBtn.onclick = async () => {
    hide(regOk);
    const email = regEmail.value.trim().toLowerCase();
    const password = regPass.value;
    const full_name = regName.value.trim();
    const username = regUser.value.trim();
    const phone = regPhone.value.trim();

    if(!(await isUsernameFree(username))){
      alert('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.');
      return;
    }

    /* === –õ–û–ì: –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ======================================= */
    try {
      await sb.from('audit_log').insert({
        event: 'auth_attempt',
        payload: { email, action: 'signup', username },
        user_agent: navigator.userAgent
      });
    } catch(e){}

    const { error } = await sb.auth.signUp({
      email, password,
      options: { data: { full_name, username, phone, role_hint:'client' } }
    });
    if(error){ alert(error.message); return; }
    show(regOk);

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    if('credentials' in navigator && window.PasswordCredential){
      try{
        const cred = new PasswordCredential({ id: email, password, name: full_name });
        await navigator.credentials.store(cred);
      }catch{}
    }
  };

  async function postAuth(){
  const { data: { user }, error: uErr } = await sb.auth.getUser();
  if(!user){ show(authModal); return; }

  // 1) –ü—Ä–æ–≤–µ—Ä—è–µ–º admin_users
  const { data: aRow, error: aErr } =
    await sb.from('admin_users').select('*').eq('id', user.id).maybeSingle();

  if (aErr) { alert('RLS admin_users: ' + aErr.message); return; }

  if (aRow){
    actor = { kind:'admin', role: aRow.role, row: aRow };
    roleBadge.textContent = aRow.role.toUpperCase();
    show(adminBtn); show(clientSwitcher); show(addDealBtn);
    hide(authModal);
    await fillAdminClientSwitcher();
    return;
  }

  // 2) –ü—Ä–æ–≤–µ—Ä—è–µ–º clients (–¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
  const { data: cRow, error: cErr } =
    await sb.from('clients').select('*').eq('id', user.id).maybeSingle();

  if (cErr) { alert('RLS clients: ' + cErr.message); return; }

  if(!cRow){ show(authModal); return; }
  if(!cRow.approved){
    show(authModal); tabLogin.click(); show(loginPending); return;
  }
  actor = { kind:'client', row: cRow };
  roleBadge.textContent = 'CLIENT';
  titleEl.textContent = '–í–∞—à —á–∞—Ç';
  hide(adminBtn); hide(clientSwitcher); hide(authModal);
  currentClientId = cRow.id;
  show(addDealBtn);
  await afterClientSelected();
}


  async function fillAdminClientSwitcher(){
    // –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ä–æ–ª–∏
    let query = sb.from('clients').select('id, full_name, username, approved, assigned_admin_team_id').order('created_at', { ascending:true });
    if(actor.role === 'admin_team'){
      query = query.eq('assigned_admin_team_id', actor.row.id);
    }
    const { data: rows, error } = await query;
    if(error){ console.error(error); return; }

    clientSwitcher.innerHTML = '';
    (rows||[]).forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r.id;
      opt.textContent = (r.full_name || r.username) + (r.approved ? '' : ' (–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥.)');
      clientSwitcher.appendChild(opt);
    });
    if(rows && rows.length){
      currentClientId = rows[0].id;
      titleEl.textContent = '–ö–ª–∏–µ–Ω—Ç: ' + (rows[0].full_name || rows[0].username);
      await afterClientSelected();
    }else{
      currentClientId = null;
      titleEl.textContent = '–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤';
      chatList.innerHTML = '';
      dealsWrap.innerHTML = '';
    }
    clientSwitcher.onchange = async ()=>{
      const sel = rows.find(x=>x.id===clientSwitcher.value);
      currentClientId = sel?.id || null;
      titleEl.textContent = sel ? ('–ö–ª–∏–µ–Ω—Ç: ' + (sel.full_name || sel.username)) : '‚Äî';
      await afterClientSelected();
    };
  }

  async function afterClientSelected(){
    await unsubscribeAll();
    await loadMessages();
    await loadDeals();
    await subscribeAll();
  }

  /********** –ß–∞—Ç **********/
  async function loadMessages(){
    chatList.innerHTML = '';
    if(!currentClientId) return;
    const { data, error } = await sb.from('messages').select('*').eq('client_id', currentClientId).order('created_at', { ascending:true }).limit(600);
    if(error){ console.error(error); return; }
    data.forEach(renderMsg);
    chatList.scrollTop = chatList.scrollHeight;
  }

  function renderMsg(m){
    const meId = (actor?.row?.id);
    const el = document.createElement('div');
    el.className = 'msg ' + (m.sender_id===meId ? 'msg--me':'');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (m.sender_id===meId ? 'bubble--me':'');
    if(m.type==='text'){
      bubble.textContent = m.content || '';
    }else if(m.type==='image'){
      const img=document.createElement('img'); img.src=m.file_url; img.alt='image'; bubble.appendChild(img);
      if(m.content){ const t=document.createElement('div'); t.style.marginTop='6px'; t.textContent=m.content; bubble.appendChild(t); }
    }else if(m.type==='video'){
      const v=document.createElement('video'); v.src=m.file_url; v.controls=true; bubble.appendChild(v);
      if(m.content){ const t=document.createElement('div'); t.style.marginTop='6px'; t.textContent=m.content; bubble.appendChild(t); }
    }else{
      const a=document.createElement('a'); a.href=m.file_url; a.target='_blank'; a.textContent='–§–∞–π–ª'; bubble.appendChild(a);
      if(m.content){ const t=document.createElement('div'); t.style.marginTop='6px'; t.textContent=m.content; bubble.appendChild(t); }
    }
    const meta=document.createElement('div'); meta.className='bubble__meta'; meta.textContent = fmt(m.created_at);
    bubble.appendChild(meta);
    el.appendChild(bubble);
    chatList.appendChild(el);
  }

  composer.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!currentClientId || !actor) return;

    let text = msgText.value.trim();
    let file = msgFile.files?.[0];
    let type='text', file_url=null;

    if(file){
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      const isImg = /(png|jpg|jpeg|webp|gif|heic|heif|bmp|avif)$/.test(ext) || file.type.startsWith('image/');
      const isVid = /(mp4|webm|mov|m4v|ogg)$/.test(ext) || file.type.startsWith('video/');
      type = isImg ? 'image' : (isVid ? 'video':'file');
      const path = `messages/${currentClientId}/${Date.now()}_${file.name}`;
      const { error: upErr } = await sb.storage.from('uploads').upload(path, file, { upsert:false });
      if(upErr){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª'); return; }
      const { data: pub } = sb.storage.from('uploads').getPublicUrl(path);
      file_url = pub.publicUrl;
    }
    if(!text && !file_url) return;

    const { error } = await sb.from('messages').insert({
      client_id: currentClientId,
      sender_id: actor.row.id,
      type, content: text || null, file_url: file_url || null
    });
    if(error){ alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); console.error(error); return; }
    msgText.value=''; msgFile.value='';
    chatList.scrollTop = chatList.scrollHeight;
  });

  /********** –°–¥–µ–ª–∫–∏ **********/
  async function loadDeals(){
    dealsWrap.innerHTML = '';
    if(!currentClientId) return;
    const { data, error } = await sb.from('deals').select('*').eq('client_id', currentClientId).order('created_at', { ascending:false });
    if(error){ console.error(error); return; }
    data.forEach(renderDeal);
  }

  function renderDeal(d){
    const el=document.createElement('div'); el.className='card deal'; el.dataset.dealId=d.id;

    const top=document.createElement('div'); top.className='deal__top';
    const title=document.createElement('div'); title.className='deal__title'; title.textContent=d.title || ('–°–¥–µ–ª–∫–∞ ' + new Date(d.created_at).toLocaleDateString());
    const toggle=document.createElement('button'); toggle.className='btn btn--ghost'; toggle.textContent='–†–∞—Å–∫—Ä—ã—Ç—å';
    toggle.onclick=()=>{ el.classList.toggle('deal--open'); toggle.textContent=el.classList.contains('deal--open')?'–°–≤–µ—Ä–Ω—É—Ç—å':'–†–∞—Å–∫—Ä—ã—Ç—å'; };
    top.appendChild(title); top.appendChild(toggle);

    const body=document.createElement('div'); body.className='deal__body';

    // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
    const sec1=document.createElement('div'); sec1.className='deal__section';
    const h1=document.createElement('h4'); h1.textContent='–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–¥–µ–ª–∫–∏'; sec1.appendChild(h1);
    const grid=document.createElement('div'); grid.className='deal__grid'; sec1.appendChild(grid);

    const addLbl=document.createElement('label'); addLbl.className='deal__add'; addLbl.textContent='+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª';
    const addInp=document.createElement('input'); addInp.type='file'; addInp.accept='image/*,video/*'; addInp.capture='environment'; addInp.className='hidden';
    addLbl.appendChild(addInp); sec1.appendChild(addLbl);

    addInp.onchange = async ()=>{
      const file = addInp.files?.[0]; if(!file) return;
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      const isImg = /(png|jpg|jpeg|webp|gif|heic|heif|bmp|avif)$/.test(ext)||file.type.startsWith('image/');
      const isVid = /(mp4|webm|mov|m4v|ogg)$/.test(ext)||file.type.startsWith('video/');
      const type = isImg ? 'image' : (isVid ? 'video':'file');

      const path=`deals/${d.id}/${Date.now()}_${file.name}`;
      const { error: upErr } = await sb.storage.from('uploads').upload(path, file, { upsert:false });
      if(upErr){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª'); return; }
      const { data: pub } = sb.storage.from('uploads').getPublicUrl(path);

      const { error } = await sb.rpc('add_deal_material', { p_deal_id: d.id, p_type: type, p_url: pub.publicUrl });
      if(error){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞'); console.error(error); }
      addInp.value='';
    };

    // –î–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
    const sec2=document.createElement('div'); sec2.className='deal__section';
    const h2=document.createElement('h4'); h2.textContent='–î–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏'; sec2.appendChild(h2);
    const form=document.createElement('div'); form.className='deal__form';
    const dtVal = d.deal_datetime ? new Date(d.deal_datetime).toISOString().slice(0,16) : '';
    form.innerHTML = `
      <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
        <input type="datetime-local" value="${dtVal}" data-k="deal_datetime">
      </label>
      <label>–ê–¥—Ä–µ—Å —Å–¥–µ–ª–∫–∏
        <input type="text" value="${d.address??''}" data-k="address">
      </label>
      <label>–ö–æ–Ω—Ç–∞–∫—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞
        <input type="text" value="${d.seller_contact??''}" data-k="seller_contact">
      </label>
      <label>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–∞
        <input type="text" value="${d.seller_ready??''}" data-k="seller_ready">
      </label>
      <label>–ö–æ–Ω—Ç–∞–∫—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        <input type="text" value="${d.buyer_contact??''}" data-k="buyer_contact">
      </label>
      <label>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        <input type="text" value="${d.buyer_ready??''}" data-k="buyer_ready">
      </label>
      <label>–ü—Ä–æ—á–µ–µ
        <textarea data-k="notes">${d.notes??''}</textarea>
      </label>
      <button class="btn btn--primary" data-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    `;
    form.querySelector('[data-action="save"]').onclick = async ()=>{
      const payload={};
      form.querySelectorAll('input,textarea').forEach(inp=>{
        let v = inp.value; const k=inp.dataset.k;
        if(k==='deal_datetime' && v){ v = new Date(v).toISOString(); }
        payload[k] = v||null;
      });
      const { error } = await sb.from('deals').update(payload).eq('id', d.id);
      if(error){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); console.error(error); }
    };

    body.appendChild(sec1); body.appendChild(sec2);

    // –†–µ–Ω–¥–µ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    const mats = Array.isArray(d.materials) ? d.materials : [];
    mats.forEach(m=>{
      if(m.type==='image'){
        const img=document.createElement('img'); img.src=m.url; grid.appendChild(img);
      }else if(m.type==='video'){
        const v=document.createElement('video'); v.src=m.url; v.controls=true; grid.appendChild(v);
      }else{
        const a=document.createElement('a'); a.href=m.url; a.target='_blank'; a.textContent='–§–∞–π–ª'; grid.appendChild(a);
      }
    });

    el.appendChild(top); el.appendChild(body);
    dealsWrap.appendChild(el);
  }

  addDealBtn.onclick = async ()=>{
    if(!currentClientId) return;
    const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏');
    if(title===null) return;
    const { error } = await sb.from('deals').insert({ client_id: currentClientId, title });
    if(error){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É'); }
  };

  /********** Realtime **********/
  async function unsubscribeAll(){
    subMsgs?.unsubscribe(); subDeals?.unsubscribe();
  }
  async function subscribeAll(){
    if(!currentClientId) return;

    subMsgs = sb.channel('messages_rt')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`client_id=eq.${currentClientId}`},(payload)=>{
        renderMsg(payload.new); chatList.scrollTop = chatList.scrollHeight;
      }).subscribe();

    subDeals = sb.channel('deals_rt')
      .on('postgres_changes',{event:'*',schema:'public',table:'deals',filter:`client_id=eq.${currentClientId}`},()=>{
        loadDeals();
      }).subscribe();
  }

  /********** –ê–¥–º–∏–Ω–ø–∞–Ω–µ–ª—å **********/
  adminBtn.onclick = async ()=>{
    await refreshAdmin();
    show(adminSheet);
  };
  adminClose.onclick = ()=> hide(adminSheet);

  async function refreshAdmin(){
    // –∑–∞—è–≤–∫–∏
    const { data: pend } = await sb.from('clients').select('id,email,full_name,username,created_at').eq('approved', false).order('created_at', { ascending:true });
    pendingList.innerHTML = '';
    (pend||[]).forEach(u=>{
      const it=document.createElement('div'); it.className='item';
      it.innerHTML = `<strong>${u.full_name || u.username}</strong><div class="muted" style="font-size:12px">${u.email||''}</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn--primary" data-approve="${u.id}">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="btn btn--ghost" data-reject="${u.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      </div>`;
      pendingList.appendChild(it);
    });
    pendingList.querySelectorAll('[data-approve]').forEach(b=>b.onclick=()=>approveClient(b.dataset.approve,true));
    pendingList.querySelectorAll('[data-reject]').forEach(b=>b.onclick=()=>approveClient(b.dataset.reject,false));

    // –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
    const { data: clients } = await sb.from('clients').select('id,full_name,username,assigned_admin_team_id').order('created_at', { ascending:true });
    const { data: team } = await sb.from('admin_users').select('id,full_name,username').eq('role','admin_team').order('full_name', { ascending:true });

    assignList.innerHTML='';
    (clients||[]).forEach(c=>{
      const it=document.createElement('div'); it.className='item';
      const sel=document.createElement('select'); sel.className='icon-btn'; sel.style.width='100%';
      const none=document.createElement('option'); none.value=''; none.textContent='‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî'; sel.appendChild(none);
      (team||[]).forEach(t=>{
        const o=document.createElement('option'); o.value=t.id; o.textContent=t.full_name || t.username;
        if(c.assigned_admin_team_id===t.id) o.selected=true; sel.appendChild(o);
      });
      sel.onchange = async ()=>{ await sb.from('clients').update({ assigned_admin_team_id: sel.value || null }).eq('id', c.id); };
      it.innerHTML = `<strong>${c.full_name || c.username}</strong>`;
      it.appendChild(sel);
      assignList.appendChild(it);
    });
  }

  async function approveClient(id, ok){
    if(actor?.role!=='admin1' && actor?.role!=='admin2'){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤'); return; }
    if(ok) await sb.from('clients').update({ approved:true }).eq('id', id);
    else   await sb.from('clients').update({ approved:false }).eq('id', id);
    await refreshAdmin();
    if(clientSwitcher && !clientSwitcher.classList.contains('hidden')) await fillAdminClientSwitcher();
  }

  /********** –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Å–≤–∞–π–ø) **********/
  let startX=null, curX=null;
  swipe.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; curX=startX; },{passive:true});
  swipe.addEventListener('touchmove',e=>{ curX=e.touches[0].clientX; },{passive:true});
  swipe.addEventListener('touchend',()=>{
    if(startX==null) return;
    const dx = curX - startX;
    if(dx<-60) goDeals();
    if(dx>60) goChat();
    startX=null; curX=null;
  });
  function goChat(){ swipe.style.transform='translateX(0%)'; tabChat.classList.add('tabbtn--active'); tabDeals.classList.remove('tabbtn--active'); }
  function goDeals(){ swipe.style.transform='translateX(-100%)'; tabDeals.classList.add('tabbtn--active'); tabChat.classList.remove('tabbtn--active'); }
  tabChat.onclick=goChat; tabDeals.onclick=goDeals;

  /********** –í—ã—Ö–æ–¥ **********/
  logoutBtn.onclick = async ()=>{
    await sb.auth.signOut();
    window.close();
    setTimeout(()=>{ location.href='about:blank'; }, 200);
  };

  /********** Init **********/
  enforceMobileOnly();
  addEventListener('resize', enforceMobileOnly);

    /********** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ **********/
  const rootStyle = document.documentElement.style;
  let baseViewportHeight = window.innerHeight;
  function updateViewportVars(){
    const vv = window.visualViewport;
    const height = vv?.height || window.innerHeight;
    if(window.innerHeight > baseViewportHeight){
      baseViewportHeight = window.innerHeight;
    }
    const offset = Math.max(baseViewportHeight - height, 0);
    rootStyle.setProperty('--viewport-height', `${height}px`);
    rootStyle.setProperty('--keyboard-offset', `${offset}px`);
  }
  updateViewportVars();
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', updateViewportVars);
    window.visualViewport.addEventListener('scroll', updateViewportVars);
  }

  (async ()=>{
    const { data:{ user } } = await sb.auth.getUser();
    if(user){ await postAuth(); } else { show(authModal); }
  })();
  </script>

  <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å–æ–∑–¥–∞–π—Ç–µ –≤ Supabase –ø—É–±–ª–∏—á–Ω—ã–π bucket 'uploads' -->
</body>
</html>

  
