<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>
  <!-- –ê–Ω—Ç–∏-–∫—ç—à –¥–ª—è HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>private messenger</title>

  <!-- ===== –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –º–µ–Ω—è–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ ===== -->
  <script>
    window.APP_VERSION = '2025-11-09-08';
    (async () => {
      try {
        const saved = localStorage.getItem('app_version');
        if (saved !== window.APP_VERSION) {
          if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
          if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
          localStorage.setItem('app_version', window.APP_VERSION);
          const url = new URL(location.href);
          url.searchParams.set('v', window.APP_VERSION);
          location.replace(url.toString());
        }
      } catch (_) {}
    })();
  </script>

  <!-- –®—Ä–∏—Ñ—Ç—ã (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –≤–µ—Ä—Å–∏–∏ –¥–ª—è –±–∞–π–ø–∞—Å–∞ –∫—ç—à–∞) -->
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap&v=2025-11-09-03" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&v=2025-11-09-03" rel="stylesheet">

  <style>
    /* =========================
       –ü–û–õ–ù–´–ô –≠–ö–†–ê–ù + –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï (px * --k)
       ========================= */
    :root{
      /* –ë–∞–∑–∞ –¥–∏–∑–∞–π–Ω–∞ */
      --k: 1; /* –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è */

      /* –¶–≤–µ—Ç–∞ */
      --bg: #212121;
      --surface: #212121;
      --text: #f4f4f5;
      --muted: #71717a;
      --border: #cfcfcf;
      --accent-bg: #f4f4f5;
      --accent-fg: #212121;

      /* –ì–µ–æ–º–µ—Ç—Ä–∏—è (–±–∞–∑–∞) */
      --radius-base: 12px;
      --radius-sm-base: 10px;
      --pad-base: 20px;

      /* –ò—Ç–æ–≥–æ–≤—ã–µ (—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ k) */
      --radius: calc(var(--radius-base) * var(--k));
      --radius-sm: calc(var(--radius-sm-base) * var(--k));
      --pad: calc(var(--pad-base) * var(--k));

      /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
      --font: 'Comfortaa', system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      --fz: calc(16px * var(--k));

      /* –¢–µ–Ω–∏ */
      --shadow-sm: 0 2px 4px rgba(0,0,0,.5);
      --shadow-md: 2px 2px 10px rgba(0,0,0, .11);

      /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      --dur: .3s;
      --bezier: cubic-bezier(0.19, 1, 0.22, 1);

      /* –û—Ç—Å—Ç—É–ø –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è –≤–∫–ª–∞–¥–æ–∫ */
      --tabs-raise: 20px; /* –ø–æ–¥–Ω–∏–º–∞–µ–º tabs –Ω–∞ 20px */
    }

    /* ====== –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ä–æ—Å—Ç k –ø–æ –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç–∞–º ====== */
    @media (min-width: 380px) and (min-height: 700px){ :root{ --k: 1.05 } }
    @media (min-width: 420px) and (min-height: 760px){ :root{ --k: 1.12 } }
    @media (min-width: 480px) and (min-height: 820px){ :root{ --k: 1.2 } }
    @media (min-width: 540px) and (min-height: 900px){ :root{ --k: 1.32 } }
    @media (min-width: 600px) and (min-height: 960px){ :root{ --k: 1.45 } }
    @media (min-width: 720px) and (min-height: 1024px){ :root{ --k: 1.6 } }
    @media (min-width: 840px) and (min-height: 1180px){ :root{ --k: 1.8 } }

    /* ====== –°–±—Ä–æ—Å—ã ====== */
    *{ margin:0; padding:0; box-sizing:border-box; font-family:var(--font) }
    html, body{ width:100vw; height:100dvh; overflow:hidden; background:var(--bg); color:var(--text); font-size:var(--fz); }

    /* ====== –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è —Å—Ü–µ–Ω–∞ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ====== */
    .stage{
      position:fixed; inset:0; display:flex; align-items:stretch; justify-content:stretch; background:var(--bg);
    }
    .modal{
      position:absolute; inset:0; /* –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
      background:var(--bg);
      border:none; border-radius:0;
      padding:var(--pad);
      overflow:hidden;
      z-index:1;
    }

    /* ====== –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –º–µ–Ω—é —Å—Ç–∞—Ç—É—Å–æ–≤ ====== */
    .modalRow{ display:flex; gap:calc(10px * var(--k)); background:none; align-items:flex-start }
    .modalColumn{ display:flex; flex-direction:column; gap:calc(10px * var(--k)); background:none }
    .title{
      color:var(--border);
      font-size:calc(20px * var(--k));
      text-transform:uppercase;
      font-weight:600;
      margin:calc(10px * var(--k)) 0 calc(20px * var(--k));
      min-width:calc(100px * var(--k));
    }

    /* ====== –ú–µ–Ω—é —Å—Ç–∞—Ç—É—Å–æ–≤ / –∫–ª–∏–µ–Ω—Ç—ã ====== */
    nav{ margin-top:0; margin-left:0; margin-right:calc(var(--pad)); }
    nav > menu{ display:flex; margin:0; padding:0; list-style:none }
    nav menu{ margin:0; padding:0; list-style:none }
    nav menuitem{ position:relative; display:block; opacity:0; cursor:pointer; z-index:10000 }
    nav > menu > menuitem{ pointer-events:all; opacity:1 }
    nav menuitem > menu{ position:absolute; pointer-events:none }
    nav > menu > menuitem menuitem menu{ transform:translateX(100%); top:0; right:0 }

    menu menuitem a{
      white-space:nowrap; display:block; user-select:none;
      background:var(--surface); color:var(--text);
      width:calc(200px * var(--k)); height:calc(304px * var(--k));
      padding:calc(10px * var(--k));
      box-sizing:border-box; border-radius:var(--radius);
      border:1px solid var(--text); box-shadow:var(--shadow-sm);
      transition: background var(--dur), color var(--dur), transform var(--dur);
    }
    menuitem:hover > menu{ pointer-events:initial }
    menuitem:hover > menu > menuitem, menu:hover > menuitem{ opacity:1 }

    nav > menu > menuitem > a + menu:after{
      content:""; position:absolute; border:calc(6px * var(--k)) solid transparent;
      border-top:calc(6px * var(--k)) solid var(--text);
      left:calc(14px * var(--k)); top:calc(-32px * var(--k));
    }
    nav menuitem > menu > menuitem > a + menu:after{
      content:""; position:absolute; border:calc(6px * var(--k)) solid transparent;
      border-left:calc(6px * var(--k)) solid var(--text);
      top:calc(14px * var(--k)); left:calc(-218px * var(--k));
      transition:opacity var(--dur), transform 0s;
    }
    nav > menu > menuitem > menu > menuitem{
      transition:transform var(--dur), opacity var(--dur);
      transform:translateY(150%); opacity:0;
    }
    nav > menu > menuitem:hover > menu > menuitem,
    nav > menu > menuitem.hover > menu > menuitem,
    #statusRoot.open > menu > menuitem{
      transform:translateY(0); opacity:1;
    }
    menuitem > menu > menuitem > menu > menuitem{
      transition:transform var(--dur), opacity var(--dur);
      transform:translateX(calc(195px * var(--k))) translateY(0); opacity:0;
    }
    menuitem > menu > menuitem:hover > menu > menuitem,
    menuitem > menu > menuitem.hover > menu > menuitem{
      transform:translateX(0) translateY(0); opacity:1;
    }
    #statusRoot.open > menu{ pointer-events:initial }
    nav a:hover{
      color:var(--surface); background:var(--text); box-shadow:0 0 calc(6px * var(--k)) var(--text);
    }
    nav a:active{
      box-shadow:0 0 calc(3px * var(--k)) var(--text); color:var(--text); transform:scale(.98); background:var(--surface);
    }
    #clientsMenu a.active{
      background:var(--text);
      color:var(--surface);
      box-shadow:0 0 calc(6px * var(--k)) var(--text);
    }

    /* ====== –í–∫–ª–∞–¥–∫–∏ ====== */
    .modalRow{ width:100%; }
    .tabs{
      display:flex; gap:calc(8px * var(--k));
      padding:calc(4px * var(--k));
      /* –†–ê–°–¢–Ø–ì–ò–í–ê–ï–ú –ù–ê –®–ò–†–ò–ù–£ –í–ù–£–¢–†–ï–ù–ù–ï–ì–û –ü–û–õ–Ø –≠–ö–†–ê–ù–ê:
         –≤–Ω—É—Ç—Ä–∏ .modal —É–∂–µ –µ—Å—Ç—å –ø–∞–¥–¥–∏–Ω–≥–∏, —Ç–∞–∫ —á—Ç–æ 100% –¥–∞—Å—Ç —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ */
      width:100%;
      box-sizing:border-box;

      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      box-shadow:rgba(0,0,0,0.1) 0 calc(4px * var(--k)) calc(6px * var(--k)) calc(-1px * var(--k)),
                 rgba(0,0,0,0.1) 0 calc(2px * var(--k)) calc(4px * var(--k)) calc(-2px * var(--k));

      /* –ü–û–î–ù–ò–ú–ê–ï–ú –¢–ê–ë–´ –ù–ê 20px */
      margin-top: calc( (10px - var(--tabs-raise)) * var(--k) ); /* 10px –±–∞–∑–æ–≤—ã–π ‚Äî 20px = -10px */
    }
    .tab{
      padding:calc(10px * var(--k)) calc(26px * var(--k));
      border:none; background:none; border-radius:calc(8px * var(--k));
      font-size:calc(16px * var(--k)); color:var(--text);
      cursor:pointer; position:relative; font-weight:600; height:fit-content;
      view-transition-name: tab-background;

      flex:1 1 0;
      min-width:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .tab.active{ color:var(--muted) }
    .tab.active::before{
      content:""; position:absolute; inset:0; height:100%; background:var(--text);
      border-radius:inherit; z-index:-1;
    }

    /* View Transitions */
    ::view-transition-group(*){
      animation-duration:.5s;
      animation-timing-function: linear(
        0,0.186 3.5%,0.352 7.1%,0.496 10.8%,0.623 14.7%,0.679 16.7%,0.732 18.8%,0.78 20.9%,0.821 23%,0.86 25.2%,0.895 27.5%,0.925 29.8%,0.951 32.2%,
        0.97 34.2%,0.986 36.3%,1 38.5%,1.012 40.7%,1.021 43%,1.028 45.4%,1.033 48%,1.036 50.7%,1.037 54.8%,1.034 59.6%,1.012 76.6%,1.004 84.2%,1.001 91.3%,1
      )
    }
    ::view-transition-group(tab-1), ::view-transition-group(tab-2), ::view-transition-group(tab-3){ z-index:1 }
    ::view-transition-old(*), ::view-transition-new(*){ height:100% }

    /* ====== –û–±—â–∞—è —Ä–∞–º–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ====== */
    .modal-content{
      position:absolute;
      left:var(--pad); right:var(--pad);
      /* –¢–µ–∫—É—â–∏–π —Ä–∞—Å—á—ë—Ç top –æ—Å—Ç–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–∞–ª–µ–∑–∞–Ω–∏—è.
         –¢–∞–±—ã –ø–æ–¥–Ω—è–ª–∏—Å—å ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–Ω–∏ –±–ª–∏–∂–µ –∫ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é, –ø—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ —Ç–µ–ø–µ—Ä—å —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞. */
      top:calc(var(--pad) + calc(20px * var(--k)) + calc(20px * var(--k)));
      margin-top:calc(10px * var(--k) + 48px * var(--k));
      bottom:var(--pad);
      border-radius:var(--radius);
      border: none;
      overflow:hidden;
    }

    /* ====== –°–µ–∫—Ü–∏–∏ ====== */
    .section{ position:absolute; inset:0; display:none; border: none; }
    .section.active{ display:block; border: none; }

    /* ====== CHAT ====== */
    .modal-chat{
      position:relative; width:100%;
      height:calc(100% - calc(56px * var(--k))); /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫–æ–º–ø–æ–∑–µ—Ä */
      overflow-y:auto; padding:calc(10px * var(--k));
    }
    .msg{ display:flex; gap:calc(8px * var(--k)); margin:calc(8px * var(--k)) calc(6px * var(--k)) }
    .msg.me{ justify-content:flex-end }
    .bubble{
      max-width:92%;
      background:transparent;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:calc(10px * var(--k)) calc(12px * var(--k));
      box-shadow:var(--shadow-sm);
      color:var(--text); line-height:1.45; font-size:calc(14px * var(--k));
    }
    .bubble.me{ background:var(--text); color:var(--accent-fg) }
    .meta{ margin-top:calc(6px * var(--k)); font-size:calc(12px * var(--k)); color:var(--muted) }

    .composer{
      position:absolute; left:0; right:0; bottom:0;
      display:flex; gap:calc(10px * var(--k)); align-items:center; padding:calc(8px * var(--k));
      background:transparent;
    }
    .input{
      flex:1; height:calc(40px * var(--k)); padding:calc(14px * var(--k));
      border-radius:var(--radius-sm); font-size:calc(15px * var(--k)); font-weight:500;
      border:1px solid var(--text); outline:none; transition:all 1s var(--bezier);
      background:var(--surface); color:var(--text);
      box-shadow:0 0 calc(20px * var(--k)) calc(-18px * var(--k)) rgba(0,0,0,.6);
      font-variant-numeric:tabular-nums;
    }
    .input:active{ transform:scale(.98) }
    .input:focus{ border:1px solid var(--text) }

    .button{
      width:calc(100px * var(--k)); height:calc(40px * var(--k)); padding:calc(10px * var(--k));
      background:var(--accent-bg); color:var(--accent-fg);
      border:1px solid var(--accent-fg);
      font-size:calc(14px * var(--k)); font-weight:600; border-radius:var(--radius-sm);
      cursor:pointer; transition:all .4s;
    }
    .button:hover{ color:var(--accent-bg); border:1px solid var(--accent-bg); background:var(--accent-fg) }

    .Btn{
      width:calc(60px * var(--k)); height:calc(40px * var(--k));
      border:1px solid rgba(214,214,214,1); border-radius:var(--radius-sm);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      cursor:pointer; position:relative; background:#333;
      transition-duration:var(--dur); box-shadow:var(--shadow-md);
    }
    .svgIcon{ fill:#fff; animation:slide-in-top 1s linear infinite; transform:scale(var(--k)) }
    .icon2{
      width:calc(18px * var(--k)); height:calc(5px * var(--k));
      border-bottom:calc(2px * var(--k)) solid #ebebeb;
      border-left:calc(2px * var(--k)) solid #ebebeb;
      border-right:calc(2px * var(--k)) solid #ebebeb;
    }
    @keyframes slide-in-top{
      0%{ transform:translateY(calc(-10px * var(--k))); opacity:0 }
      100%{ transform:translateY(0); opacity:1 }
    }

    /* ====== CONTRACTS ====== */
    .contracts{ position:absolute; inset:0; display:flex; flex-direction:column }
    .contracts-head{
      padding:calc(10px * var(--k)); display:flex; justify-content:space-between; align-items:center; font-size:calc(16px * var(--k));
    }
    .contracts-list{
      flex:1; overflow:auto; padding:calc(10px * var(--k));
      display:flex; flex-direction:column; gap:calc(10px * var(--k));
    }
    .deal{
      border:1px solid var(--border); border-radius:var(--radius);
      padding:calc(12px * var(--k)); background:transparent; box-shadow:var(--shadow-sm);
      font-size:calc(14px * var(--k));
    }
    .deal h4{ font-size:calc(16px * var(--k)); margin-bottom:calc(6px * var(--k)) }
    .deal small{ color:var(--muted) }

    /* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
    .hidden{ display:none !important }

    /* ====== –ê–¥–∞–ø—Ç–∏–≤ ====== */
    @media (max-width: 660px){
      menu menuitem a{ width:calc(100vw - calc(80px * var(--k))) }
      .tab{ min-width:auto }
    }
  </style>
</head>
<body>
  <!-- ===== –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° –ü–û –¢–í–û–ï–ô –†–ê–ó–ú–ï–¢–ö–ï ===== -->
  <div class="stage">
    <div class="modal" id="appModal">
      <div class="modalRow" style="align-items:flex-start; justify-content:space-between">
        <div class="title" id="roleTitle">Admin 1</div>
        <nav id="statusNav">
          <menu>
            <menuitem id="statusRoot">
              <a>status</a>
              <menu id="clientsMenu">
                <!-- —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏–ª–µ—Ç—è—Ç –∫–ª–∏–µ–Ω—Ç—ã (menuitem>a) -->
              </menu>
            </menuitem>
          </menu>
        </nav>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabChat" style="view-transition-name: tab-1">CHAT</button>
        <button class="tab" id="tabContracts" style="view-transition-name: tab-2">CONTRACTS</button>
      </div>

      <div class="modal-content" style="border: none;">
        <!-- ====== CHAT ====== -->
        <section class="section active" id="sectionChat">
          <div class="modal-chat" id="chatList"></div>
          <div class="composer">
            <input class="input" id="msgText" placeholder="your message.." autocomplete="off" />
            <button class="Btn" id="attachBtn" title="Attach">
              <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" class="svgIcon">
                <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"/>
              </svg>
              <span class="icon2"></span>
              <input id="fileInput" type="file" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z" hidden />
            </button>
            <button class="button" id="sendBtn">send</button>
          </div>
        </section>

        <!-- ====== CONTRACTS ====== -->
        <section class="section" id="sectionContracts">
          <div class="contracts">
            <div class="contracts-head">
              <strong>Contracts</strong>
              <button class="button" id="addDealBtn">+ add</button>
            </div>
            <div class="contracts-list" id="dealsList"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Supabase UMD (—Å –≤–µ—Ä—Å–∏–µ–π –¥–ª—è –∫—ç—à-–±–∞–π–ø–∞—Å–∞) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js?v=2025-11-09-03"></script>

  <script>
    /********** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase **********/
    const SUPABASE_URL = "https://guoacfwfjunuqpdvjfwp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1b2FjZndmanVudXFwZHZqZndwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MDEwODYsImV4cCI6MjA3ODE3NzA4Nn0.WuUs9pXqncVnRm33K-Y3DQcpQByk4xVoxVqPPneqRxI";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
      realtime: { params: { eventsPerSecond: 5 } }
    });

    /********** DOM **********/
    const roleTitle = document.getElementById('roleTitle');

    const tabChat = document.getElementById('tabChat');
    const tabContracts = document.getElementById('tabContracts');
    const sectionChat = document.getElementById('sectionChat');
    const sectionContracts = document.getElementById('sectionContracts');

    const chatList = document.getElementById('chatList');
    const msgText = document.getElementById('msgText');
    const sendBtn = document.getElementById('sendBtn');
    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('fileInput');

    const dealsList = document.getElementById('dealsList');
    const addDealBtn = document.getElementById('addDealBtn');

    const clientsMenu = document.getElementById('clientsMenu');
    const statusNav = document.getElementById('statusNav');
    const statusRoot = document.getElementById('statusRoot');
    const statusToggle = statusRoot?.querySelector('a');

    function closeStatusMenu(){
      statusRoot?.classList.remove('open');
    }

    statusToggle?.addEventListener('click', (event)=>{
      event.preventDefault();
      event.stopPropagation();
      statusRoot?.classList.toggle('open');
    });

    document.addEventListener('click', (event)=>{
      if(statusNav && !statusNav.contains(event.target)){
        closeStatusMenu();
      }
    });

    document.addEventListener('keydown', (event)=>{
      if(event.key === 'Escape'){
        closeStatusMenu();
      }
    });

    /********** –°–æ—Å—Ç–æ—è–Ω–∏–µ **********/
    let actor = null;           // { kind:'admin'|'client', role?: 'admin1'|'admin2'|'admin_team', row }
    let currentClientId = null;
    let clientsCache = [];
    let subMsgs = null, subDeals = null;
    const pendingFiles = [];

    /********** –£—Ç–∏–ª–∏—Ç—ã **********/
    const fmt = ts => new Date(ts).toLocaleString();
    const IMG = /(png|jpg|jpeg|webp|gif|heic|heif|bmp|avif)$/i;
    const VID = /(mp4|webm|mov|m4v|ogg)$/i;
    const AUD = /(mp3|wav|ogg|m4a|aac|flac)$/i;

    function kindOf(file){
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      if(file.type.startsWith('image/') || IMG.test(ext)) return 'image';
      if(file.type.startsWith('video/') || VID.test(ext)) return 'video';
      if(file.type.startsWith('audio/') || AUD.test(ext)) return 'audio';
      return 'file';
    }
    function sanitize(name){
      return (name||'file').trim().replace(/[^a-zA-Z0-9_.-]+/g,'_') || 'file';
    }

    /********** –í–∫–ª–∞–¥–∫–∏ —Å View Transitions **********/
    [tabChat, tabContracts].forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.startViewTransition?.(() => {
          tabChat.classList.toggle('active', btn === tabChat);
          tabContracts.classList.toggle('active', btn === tabContracts);
          sectionChat.classList.toggle('active', btn === tabChat);
          sectionContracts.classList.toggle('active', btn === tabContracts);
        }) || (() => {
          tabChat.classList.toggle('active', btn === tabChat);
          tabContracts.classList.toggle('active', btn === tabContracts);
          sectionChat.classList.toggle('active', btn === tabChat);
          sectionContracts.classList.toggle('active', btn === tabContracts);
        })();
      });
    });

    /********** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–æ–ª—å **********/
    (async ()=>{
      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        // –ï—Å–ª–∏ –ª–æ–≥–∏–Ω –≤–Ω–µ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—á–∏—Ç–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
        roleTitle.textContent = 'Client';
        actor = { kind:'client', row: { id: 'anonymous' } };
        await bootstrapAsClient();
        return;
      }
      // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∞–¥–º–∏–Ω–∞
      const { data: aRow } = await sb.from('admin_users').select('*').eq('id', user.id).maybeSingle();
      if(aRow){
        actor = { kind:'admin', role: aRow.role, row: aRow };
        roleTitle.textContent = (aRow.role || 'admin').replace('_',' ');
        await bootstrapAsAdmin();
        return;
      }
      // –ò–Ω–∞—á–µ ‚Äî –∫–ª–∏–µ–Ω—Ç
      const { data: cRow } = await sb.from('clients').select('*').eq('id', user.id).maybeSingle();
      actor = { kind:'client', row: cRow || { id: user.id } };
      roleTitle.textContent = 'Client';
      await bootstrapAsClient();
    })();

    async function bootstrapAsAdmin(){
      // –º–µ–Ω—é –∫–ª–∏–µ–Ω—Ç–æ–≤
      await fillClientsMenu();
      await reloadAll();
    }

    async function bootstrapAsClient(){
      // –≤—ã—è—Å–Ω—è–µ–º —Å–≤–æ–π client_id
      if(actor.row?.id){
        const { data: self } = await sb.from('clients').select('id').eq('id', actor.row.id).maybeSingle();
        currentClientId = self?.id || null;
      }
      await loadChat();
      await loadDeals();
      subscribe();
    }

     function clientDisplayName(row){
      return (row?.full_name || row?.username || row?.id || '').trim() || '–ö–ª–∏–µ–Ω—Ç';
    }

    function updateStatusLabel(client){
      if(!statusToggle) return;
      statusToggle.textContent = client ? clientDisplayName(client) : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞';
    }

    function highlightActiveClient(){
      if(!clientsMenu) return;
      const links = clientsMenu.querySelectorAll('a[data-client-id]');
      links.forEach(link => {
        link.classList.toggle('active', link.dataset.clientId === currentClientId);
      });
    }

    async function fillClientsMenu(){
      if(!clientsMenu) return;
      clientsMenu.innerHTML = '';
      let query = sb.from('clients').select('id, full_name, username, approved').order('created_at', { ascending:true });
      if(actor.role === 'admin_team'){
        query = query.eq('assigned_admin_team_id', actor.row.id);
      }
      const { data: rows } = await query;
      clientsCache = rows || [];

      if(!clientsCache.length){
        updateStatusLabel(null);
        currentClientId = null;
        const mi = document.createElement('menuitem');
        const stub = document.createElement('span');
        stub.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤';
        stub.style.display = 'block';
        stub.style.opacity = '0.7';
        stub.style.padding = '10px';
        stub.style.whiteSpace = 'nowrap';
        mi.appendChild(stub);
        clientsMenu.appendChild(mi);
        return;
      }

      if(!currentClientId || !clientsCache.some(c => c.id === currentClientId)){
        currentClientId = clientsCache[0]?.id || null;
      }

      clientsCache.forEach(r=>{
        const mi = document.createElement('menuitem');
        const a = document.createElement('a');
        a.textContent = clientDisplayName(r) + (r.approved ? '' : ' (–Ω–µ –ø–æ–¥—Ç–≤.)');
        a.href = 'javascript:void(0)';
        a.dataset.clientId = r.id;
        a.addEventListener('click', async (event)=>{
          event.preventDefault();
          if(currentClientId === r.id){
            closeStatusMenu();
            return;
          }
          currentClientId = r.id;
          updateStatusLabel(r);
          highlightActiveClient();
          closeStatusMenu();
          await reloadAll();
        });
        mi.appendChild(a);
        clientsMenu.appendChild(mi);
      });

      const activeClient = clientsCache.find(c => c.id === currentClientId) || null;
      updateStatusLabel(activeClient);
      highlightActiveClient();
    }

    /********** –ß–∞—Ç **********/
    async function loadChat(){
      chatList.innerHTML = '';
      if(!currentClientId) return;
      const { data, error } = await sb
        .from('messages')
        .select('*')
        .eq('client_id', currentClientId)
        .order('created_at', { ascending:true })
        .limit(600);
      if(error) { console.error(error); return; }
      (data||[]).forEach(renderMsg);
      chatList.scrollTop = chatList.scrollHeight;
    }

    function renderMsg(m){
      const isMe = m.sender_id === (actor?.row?.id);
      const wrap = document.createElement('div');
      wrap.className = 'msg' + (isMe ? ' me' : '');

      const bubble = document.createElement('div');
      bubble.className = 'bubble' + (isMe ? ' me' : '');
      if(m.type === 'bundle'){
        // –æ–∂–∏–¥–∞–µ–º JSON: { text, attachments:[{type,url,name,size}] }
        let payload = null;
        if(typeof m.content === 'string'){ try{ payload = JSON.parse(m.content) }catch{} }
        if(m.content && typeof m.content === 'object'){ payload = m.content }
        const text = payload?.text;
        const atts = Array.isArray(payload?.attachments) ? payload.attachments : [];

        if(atts.length){
          const grid = document.createElement('div');
          grid.style.display = 'grid';
          grid.style.gridTemplateColumns = 'repeat(auto-fit,minmax(120px,1fr))';
          grid.style.gap = '8px';
          grid.style.marginBottom = text ? '8px' : '0';
          atts.forEach(a=>{
            const cell = document.createElement('div');
            cell.style.border = '1px solid var(--border)';
            cell.style.borderRadius = '10px';
            cell.style.overflow = 'hidden';
            if(a.type === 'image'){
              const im = document.createElement('img'); im.src=a.url; im.alt=a.name||'image'; im.style.width='100%'; im.style.display='block';
              cell.appendChild(im);
            }else if(a.type === 'video'){
              const v = document.createElement('video'); v.src=a.url; v.controls=true; v.style.width='100%';
              cell.appendChild(v);
            }else if(a.type === 'audio'){
              const au = document.createElement('audio'); au.src=a.url; au.controls=true; au.style.width='100%';
              cell.appendChild(au);
            }else{
              const link = document.createElement('a'); link.href=a.url; link.target='_blank'; link.textContent='üìé '+(a.name||'file');
              link.style.display='block'; link.style.padding='8px';
              cell.appendChild(link);
            }
            grid.appendChild(cell);
          });
          bubble.appendChild(grid);
        }
        if(text){
          const t = document.createElement('div');
          t.textContent = text;
          bubble.appendChild(t);
        }
      } else if (m.type === 'text'){
        bubble.textContent = m.content || '';
      } else if (m.type === 'image'){
        const im = document.createElement('img'); im.src=m.file_url; im.alt='image'; im.style.maxWidth='100%';
        bubble.appendChild(im);
        if(m.content){ const t=document.createElement('div'); t.style.marginTop='6px'; t.textContent=m.content; bubble.appendChild(t); }
      } else if (m.type === 'video'){
        const v = document.createElement('video'); v.src=m.file_url; v.controls=true; v.style.maxWidth='100%';
        bubble.appendChild(v);
        if(m.content){ const t=document.createElement('div'); t.style.marginTop='6px'; t.textContent=m.content; bubble.appendChild(t); }
      } else if (m.type === 'audio'){
        const a = document.createElement('audio'); a.src=m.file_url; a.controls=true; a.style.width='100%';
        bubble.appendChild(a);
        if(m.content){ const t=document.createElement('div'); t.style.marginTop='6px'; t.textContent=m.content; bubble.appendChild(t); }
      } else {
        const link = document.createElement('a'); link.href=m.file_url; link.target='_blank'; link.textContent='üìé —Ñ–∞–π–ª';
        bubble.appendChild(link);
        if(m.content){ const t=document.createElement('div'); t.style.marginTop='6px'; t.textContent=m.content; bubble.appendChild(t); }
      }

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = fmt(m.created_at);
      bubble.appendChild(meta);

      wrap.appendChild(bubble);
      chatList.appendChild(wrap);
    }

    attachBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=>{
      pendingFiles.splice(0, pendingFiles.length, ...Array.from(fileInput.files || []));
    });

    sendBtn.addEventListener('click', async ()=>{
      if(!currentClientId || !actor) return;
      const text = msgText.value.trim();
      if(!text && !pendingFiles.length) return;

      sendBtn.disabled = true;
      try{
        const uploaded = [];
        if(pendingFiles.length){
          const stamp = Date.now();
          for(let i=0;i<pendingFiles.length;i++){
            const f = pendingFiles[i];
            const k = kindOf(f);
            const safe = sanitize(f.name);
            const path = `messages/${currentClientId}/${stamp}_${i}_${safe}`;
            const { error: upErr } = await sb.storage.from('uploads').upload(path, f, { upsert:false });
            if(upErr){ alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); throw upErr; }
            const { data: pub } = sb.storage.from('uploads').getPublicUrl(path);
            uploaded.push({ type:k, url:pub.publicUrl, name:f.name, size:f.size });
          }
        }

        let type = 'text';
        let content = text || null;
        let file_url = null;

        if(uploaded.length){
          if(uploaded.length === 1 && !text){
            type = uploaded[0].type;
            file_url = uploaded[0].url;
            content = null;
          } else {
            type = 'bundle';
            content = JSON.stringify({ text, attachments: uploaded });
            file_url = null;
          }
        }

        const { error } = await sb.from('messages').insert({
          client_id: currentClientId,
          sender_id: actor.row.id,
          type, content, file_url
        });
        if(error){ alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); console.error(error); return; }

        msgText.value = '';
        fileInput.value = '';
        pendingFiles.splice(0, pendingFiles.length);
        chatList.scrollTop = chatList.scrollHeight;
      }finally{
        sendBtn.disabled = false;
      }
    });

    /********** CONTRACTS **********/
    async function loadDeals(){
      dealsList.innerHTML = '';
      if(!currentClientId) return;
      const { data, error } = await sb
        .from('deals')
        .select('*')
        .eq('client_id', currentClientId)
        .order('created_at', { ascending:false });
      if(error){ console.error(error); return; }
      (data||[]).forEach(renderDeal);
    }
    function renderDeal(d){
      const el = document.createElement('div');
      el.className = 'deal';
      el.innerHTML = `
        <h4>${d.title || '–°–¥–µ–ª–∫–∞'}</h4>
        <small>${fmt(d.created_at)}</small>
        ${d.address ? `<div style="margin-top:6px">üìç ${d.address}</div>` : ''}
      `;
      dealsList.appendChild(el);
    }
    addDealBtn.addEventListener('click', async ()=>{
      if(!currentClientId) return;
      const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏');
      if(title === null) return;
      const { error } = await sb.from('deals').insert({ client_id: currentClientId, title });
      if(error){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É'); }
    });

    /********** Realtime **********/
    function subscribe(){
      subMsgs?.unsubscribe?.();
      subDeals?.unsubscribe?.();
      if(!currentClientId) return;

      subMsgs = sb.channel('messages_rt')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`client_id=eq.${currentClientId}`}, (p)=>{
          renderMsg(p.new);
          chatList.scrollTop = chatList.scrollHeight;
        }).subscribe();

      subDeals = sb.channel('deals_rt')
        .on('postgres_changes',{event:'*',schema:'public',table:'deals',filter:`client_id=eq.${currentClientId}`}, ()=>{
          loadDeals();
        }).subscribe();
    }

    async function reloadAll(){
      await loadChat();
      await loadDeals();
      subscribe();
    }

    /********** Service Worker + –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ **********/
    if ('serviceWorker' in navigator) {
      const v = (window.APP_VERSION || Date.now()).toString();
      navigator.serviceWorker.register('/sw.js?v=' + v).then(reg => {
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing;
          nw && nw.addEventListener('statechange', () => {
            if (nw.state === 'activated' && navigator.serviceWorker.controller) {
              location.reload();
            }
          });
        });
      }).catch(console.warn);
    }
  </script>
</body>
</html>
